<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„æºå…±äº«å¹³å°</title>
    <style>
        .upload-progress-item{padding:.8rem;border:1px solid var(--border);border-radius:8px;margin-bottom:.8rem;background:var(--card);transition:all .3s}.upload-progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.upload-progress-name{font-size:.8rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}.upload-progress-size{font-size:.7rem;color:var(--text-muted);margin-left:.5rem}.upload-progress-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:.4rem}.upload-progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-dark));width:0%;transition:width .3s ease;border-radius:4px}.upload-progress-stats{display:flex;justify-content:space-between;align-items:center;font-size:.7rem;color:var(--text-muted)}.upload-progress-percent{font-weight:600;color:var(--primary)}.progress-completed{border-left:4px solid var(--success)}.progress-error{border-left:4px solid var(--danger)}*{margin:0;padding:0;box-sizing:border-box}:root{--primary:#3498db;--primary-dark:#2980b9;--bg:#f5f7fa;--card:#fff;--card-hover:#f8f9fa;--text:#2c3e50;--text-muted:#7f8c8d;--border:#e1e8ed;--success:#2ecc71;--danger:#e74c3c;--warning:#f39c12;--shadow:0 4px 12px rgba(0,0,0,.08)}body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}header{background:var(--card);box-shadow:var(--shadow);position:sticky;top:0;z-index:100}.header-content{max-width:1400px;margin:0 auto;padding:.6rem 1.5rem;display:flex;justify-content:space-between;align-items:center}.logo{font-size:1.2rem;font-weight:700;color:var(--primary);display:flex;align-items:center;gap:.4rem}.nav-btns{display:flex;gap:.6rem;align-items:center}.btn{padding:.4rem .8rem;border-radius:6px;border:none;cursor:pointer;font-weight:500;transition:all .3s;display:inline-flex;align-items:center;gap:.3rem;font-size:.8rem}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 6px 12px rgba(52,152,219,.3)}.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}.btn-ghost:hover{background:var(--card-hover);transform:translateY(-1px)}.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#c0392b;transform:translateY(-2px)}.btn-sm{padding:.25rem .5rem;font-size:.7rem}.user-info{display:flex;align-items:center;gap:.6rem}.user-avatar{width:28px;height:28px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.85rem}.hero{padding:1.5rem 1.5rem 1rem;text-align:center;background:var(--card);margin-bottom:1rem;box-shadow:var(--shadow)}.hero h1{font-size:1.6rem;margin-bottom:.6rem;color:var(--primary)}.hero p{color:var(--text-muted);font-size:.9rem;max-width:500px;margin:0 auto 1rem}.stats{display:flex;justify-content:center;gap:1.5rem;margin-top:.8rem;flex-wrap:wrap}.stat{text-align:center;padding:.6rem;transition:transform .3s;min-width:90px}.stat:hover{transform:translateY(-3px)}.stat-value{font-size:1.3rem;font-weight:700;color:var(--primary)}.stat-label{color:var(--text-muted);font-size:.75rem;margin-top:.2rem}.announcements{max-width:1400px;margin:0 auto 1rem;padding:0 1.5rem}.announcement-bar{background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.3);border-radius:8px;padding:.6rem 1rem;display:flex;align-items:center;gap:.6rem;transition:all .3s}.announcement-bar:hover{transform:translateY(-2px);box-shadow:var(--shadow)}.announcement-content{flex:1;overflow:hidden}.announcement-title{font-weight:600;color:var(--text);font-size:.85rem}.announcement-text{color:var(--text-muted);font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}main{max-width:1400px;margin:0 auto;padding:0 1.5rem 2rem}.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.8rem}.categories{display:flex;gap:.3rem;flex-wrap:wrap}.cat-btn{padding:.35rem .7rem;border-radius:14px;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;transition:all .3s;font-size:.75rem}.cat-btn:hover,.cat-btn.active{background:var(--primary);border-color:var(--primary);color:#fff;transform:translateY(-1px)}.search-box{display:flex;gap:.3rem}.search-box input{padding:.4rem .7rem;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);width:200px;outline:none;transition:all .3s;font-size:.8rem}.search-box input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(52,152,219,.2)}.resource-grid{display:grid;gap:.8rem}.resource-card{background:var(--card);border-radius:10px;overflow:hidden;border:1px solid var(--border);transition:all .3s;cursor:pointer;box-shadow:var(--shadow)}.resource-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15);border-color:var(--primary)}.card-preview{height:110px;background:#f8f9fa;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}.card-preview img{width:100%;height:100%;object-fit:cover;transition:transform .5s}.card-preview:hover img{transform:scale(1.05)}.card-preview video{width:100%;height:100%;object-fit:cover}.card-preview .file-icon{font-size:2.2rem;color:var(--primary);opacity:.8}.file-type-badge{position:absolute;top:5px;right:5px;padding:.15rem .35rem;border-radius:3px;background:rgba(0,0,0,.7);color:#fff;font-size:.55rem;text-transform:uppercase}.card-body{padding:.7rem}.card-title{font-weight:600;margin-bottom:.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.85rem}.card-desc{color:var(--text-muted);font-size:.7rem;margin-bottom:.6rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2rem;line-height:1.3}.card-meta{display:flex;justify-content:space-between;align-items:center;color:var(--text-muted);font-size:.65rem}.card-meta span{display:flex;align-items:center;gap:.15rem}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;backdrop-filter:blur(5px)}.modal-overlay.active{display:flex;animation:fadeIn .3s}.modal{background:var(--card);border-radius:12px;width:100%;max-width:450px;max-height:90vh;overflow-y:auto;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.2);transform:translateY(20px);opacity:0;transition:all .3s}.modal-overlay.active .modal{transform:translateY(0);opacity:1}.modal-lg{max-width:800px}.modal-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:relative}.modal-header h2{font-size:1.1rem}.modal-close{background:none;border:none;color:var(--text-muted);font-size:1.6rem;cursor:pointer;transition:all .3s;padding:.3rem;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;position:absolute;right:1rem;top:50%;transform:translateY(-50%)}.modal-close:hover{color:var(--text);transform:translateY(-50%) rotate(90deg);background:rgba(0,0,0,.05)}.modal-body{padding:1rem}.form-group{margin-bottom:.8rem}.form-group label{display:block;margin-bottom:.3rem;color:var(--text-muted);font-size:.8rem}.form-group input,.form-group select,.form-group textarea{width:100%;padding:.6rem .8rem;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);outline:none;font-size:.85rem;transition:all .3s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(52,152,219,.2)}.form-group textarea{resize:vertical;min-height:70px;font-size:.85rem}.modal-footer{padding:1rem;border-top:1px solid var(--border);display:flex;gap:.6rem;justify-content:flex-end}.upload-area{border:2px dashed var(--border);border-radius:12px;padding:1.5rem;text-align:center;cursor:pointer;transition:all .3s}.upload-area:hover,.upload-area.dragover{border-color:var(--primary);background:rgba(52,152,219,.05);transform:translateY(-3px)}.upload-area p{color:var(--text-muted);font-size:.85rem}.global-progress{position:fixed;top:65px;right:15px;width:380px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.8rem;box-shadow:var(--shadow);z-index:1001;display:none;max-height:500px;overflow:hidden;flex-direction:column}.global-progress.active{display:flex;animation:slideInDown .3s}.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;flex-shrink:0}.progress-title{font-weight:600;font-size:.85rem}.progress-close{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;padding:.15rem;border-radius:3px}.progress-close:hover{background:var(--bg);color:var(--text)}.progress-list{max-height:420px;overflow-y:auto;flex:1}.progress-item{margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px solid var(--border)}.progress-item:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}.upload-area.multiple{padding:1.2rem}.file-list{margin-top:.8rem;max-height:180px;overflow-y:auto}.file-item{display:flex;justify-content:space-between;align-items:center;padding:.4rem;background:var(--bg);border-radius:5px;margin-bottom:.3rem;font-size:.8rem}.file-item:last-child{margin-bottom:0}.file-item-info{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.file-item-remove{background:none;border:none;color:var(--danger);cursor:pointer;padding:.15rem .3rem;border-radius:3px;margin-left:.4rem}.file-item-remove:hover{background:var(--danger);color:#fff}@keyframes slideInDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.preview-container{background:var(--bg);border-radius:8px;overflow:hidden;margin-bottom:1rem}.preview-container img,.preview-container video{max-width:100%;max-height:320px;display:block;margin:0 auto}.preview-container audio{width:100%}.preview-container pre{padding:.7rem;max-height:320px;overflow:auto;font-size:.75rem;background:#f8f9fa;border-radius:5px}.preview-container iframe{width:100%;height:420px;border:none}.admin-tabs{display:flex;gap:.3rem;margin-bottom:1rem;border-bottom:1px solid var(--border);padding-bottom:.6rem}.admin-tab{padding:.4rem .8rem;border-radius:5px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;transition:all .3s;font-size:.8rem}.admin-tab:hover,.admin-tab.active{background:var(--primary);color:#fff;transform:translateY(-1px)}.admin-table{width:100%;border-collapse:collapse;font-size:.8rem}.admin-table th,.admin-table td{padding:.7rem;text-align:left;border-bottom:1px solid var(--border)}.admin-table th{color:var(--text-muted);font-weight:500;font-size:.75rem}.admin-table tr{transition:all .3s}.admin-table tr:hover{background:rgba(52,152,219,.05);transform:translateX(3px)}.badge{padding:.15rem .4rem;border-radius:3px;font-size:.65rem;font-weight:500}.badge-admin{background:rgba(231,76,60,.1);color:#e74c3c}.badge-user{background:rgba(46,204,113,.1);color:#2ecc71}.pagination{display:flex;justify-content:center;gap:.3rem;margin-top:1rem}.page-btn{width:32px;height:32px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all .3s;font-size:.75rem}.page-btn:hover,.page-btn.active{background:var(--primary);border-color:var(--primary);color:#fff;transform:translateY(-1px)}.page-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}.toast-container{position:fixed;top:15px;right:15px;z-index:2000}.toast{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:.7rem 1rem;margin-bottom:.3rem;display:flex;align-items:center;gap:.5rem;animation:slideIn .3s ease;box-shadow:0 8px 25px rgba(0,0,0,.15);transition:all .3s;font-size:.8rem}.toast:hover{transform:translateX(-3px)}.toast.success{border-left:4px solid var(--success)}.toast.error{border-left:4px solid var(--danger)}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.loading{display:flex;justify-content:center;padding:1.5rem}.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.form-row{display:flex;gap:.6rem;margin-bottom:.6rem}.form-row .form-group{flex:1;margin-bottom:0}@media(min-width:1400px){.resource-grid{grid-template-columns:repeat(8,1fr)}}@media(min-width:1200px)and (max-width:1399px){.resource-grid{grid-template-columns:repeat(6,1fr)}}@media(min-width:992px)and (max-width:1199px){.resource-grid{grid-template-columns:repeat(4,1fr)}}@media(min-width:768px)and (max-width:991px){.resource-grid{grid-template-columns:repeat(3,1fr)}.hero{padding:1.2rem .8rem .8rem}.hero h1{font-size:1.4rem}.stats{gap:1.2rem}.toolbar{flex-direction:column;align-items:stretch}.search-box input{width:100%}.modal{margin:.4rem}.form-row{flex-direction:column;gap:0}}@media(min-width:576px)and (max-width:767px){.resource-grid{grid-template-columns:repeat(2,1fr)}.header-content{padding:.5rem .8rem}.hero{padding:1rem .6rem .6rem}.hero h1{font-size:1.2rem}.hero p{font-size:.85rem}.stats{gap:.8rem}.stat{padding:.5rem;min-width:75px}.stat-value{font-size:1.1rem}.stat-label{font-size:.7rem}.announcements{padding:0 .8rem;margin-bottom:.8rem}.announcement-bar{padding:.5rem}main{padding:0 .8rem 1.2rem}.toolbar{flex-direction:column;align-items:stretch;gap:.6rem}.categories{justify-content:center}.search-box input{width:100%}.modal{margin:.2rem}.modal-header{padding:.9rem}.modal-body{padding:.9rem}.modal-footer{padding:.9rem}}@media(max-width:575px){.resource-grid{grid-template-columns:repeat(2,1fr)}.header-content{padding:.4rem .6rem;flex-direction:column;gap:.6rem}.nav-btns{width:100%;justify-content:center}.hero{padding:.8rem .5rem .5rem}.hero h1{font-size:1.1rem}.hero p{font-size:.8rem;margin-bottom:.8rem}.stats{gap:.6rem}.stat{padding:.4rem;min-width:65px}.stat-value{font-size:1rem}.stat-label{font-size:.65rem}.announcements{padding:0 .6rem;margin-bottom:.6rem}.announcement-bar{padding:.4rem}main{padding:0 .6rem 1rem}.toolbar{flex-direction:column;align-items:stretch;gap:.5rem}.categories{justify-content:center}.search-box input{width:100%}.modal{margin:.15rem}.modal-header{padding:.7rem}.modal-body{padding:.7rem}.modal-footer{padding:.7rem;flex-direction:column}.modal-footer .btn{width:100%}.upload-area{padding:1rem}.admin-tabs{flex-wrap:wrap}.admin-tab{flex:1;min-width:90px;text-align:center}.user-info{flex-direction:column;gap:.3rem}.global-progress{width:320px;right:10px;top:60px}}@media(max-width:400px){.resource-grid{grid-template-columns:1fr}.stats{gap:.4rem}.stat{min-width:55px;padding:.3rem}}
    </style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>
<div class="global-progress" id="globalProgress">
    <div class="progress-header">
        <div class="progress-title">ğŸ“¤ ä¸Šä¼ è¿›åº¦</div>
        <button class="progress-close" onclick="hideGlobalProgress()">&times;</button>
    </div>
    <div class="progress-list" id="progressList"></div>
</div>

<header>
    <div class="header-content">
        <div class="logo">â˜ äº‘èµ„æºå…±äº«</div>
        <div class="nav-btns" id="navBtns"></div>
    </div>
</header>

<section class="hero">
    <h1>å‘ç° Â· åˆ†äº« Â· ä¸‹è½½</h1>
    <p>ä¸€ä¸ªç®€æ´é«˜æ•ˆçš„èµ„æºå…±äº«å¹³å°ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼é¢„è§ˆå’Œé«˜é€Ÿä¼ è¾“</p>
    <div class="stats" id="statsContainer"></div>
</section>

<div class="announcements" id="announcementSection"></div>

<main>
    <div class="toolbar">
        <div class="categories" id="categories"></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢æ–‡ä»¶åæˆ–æè¿°...">
            <button class="btn btn-primary" onclick="searchResources()">ğŸ”</button>
        </div>
    </div>
    <div class="resource-grid" id="resourceGrid"></div>
    <div class="pagination" id="pagination"></div>
</main>

<div class="modal-overlay" id="loginModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="authModalTitle">ç™»å½•</h2>
            <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="authUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="authPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="toggleAuthMode()" id="authToggle">æ²¡æœ‰è´¦å·ï¼Ÿæ³¨å†Œ</button>
            <button class="btn btn-primary" onclick="submitAuth()" id="authSubmit">ç™»å½•</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="uploadModal">
    <div class="modal">
        <div class="modal-header">
            <h2>ä¸Šä¼ èµ„æº</h2>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-area multiple" id="uploadArea">
                <p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p style="font-size:.7rem;margin-top:.3rem;color:var(--primary)">æ”¯æŒå¤šæ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§7GB</p>
                <input type="file" id="fileInput" multiple hidden>
            </div>
            <div class="file-list" id="fileList"></div>
            <div class="form-group" style="margin-top:.6rem">
                <label>èµ„æºæè¿°ï¼ˆåº”ç”¨äºæ‰€æœ‰æ–‡ä»¶ï¼‰</label>
                <textarea id="uploadDesc" placeholder="è¯·è¾“å…¥èµ„æºæè¿°..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeUploadModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="startUpload()">ğŸ“¤ å¼€å§‹ä¸Šä¼ </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 id="detailTitle">èµ„æºè¯¦æƒ…</h2>
            <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailBody"></div>
        <div class="modal-footer" id="detailFooter"></div>
    </div>
</div>

<div class="modal-overlay" id="adminModal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2>ç®¡ç†é¢æ¿</h2>
            <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('users')">ç”¨æˆ·ç®¡ç†</button>
                <button class="admin-tab" onclick="switchAdminTab('announcements')">å…¬å‘Šç®¡ç†</button>
            </div>
            <div id="adminContent"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="userEditModal">
    <div class="modal">
        <div class="modal-header">
            <h2>ç¼–è¾‘ç”¨æˆ·</h2>
            <button class="modal-close" onclick="closeModal('userEditModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="editUsername">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="editPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="editRole">
                    <option value="user">æ™®é€šç”¨æˆ·</option>
                    <option value="admin">ç®¡ç†å‘˜</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('userEditModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="userEditSubmit">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addUserModal">
    <div class="modal">
        <div class="modal-header">
            <h2>æ·»åŠ ç”¨æˆ·</h2>
            <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="addUsername">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="addPassword">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="addRole">
                    <option value="user">æ™®é€šç”¨æˆ·</option>
                    <option value="admin">ç®¡ç†å‘˜</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('addUserModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="addUser()">æ·»åŠ </button>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
const API = '/api';
let token = localStorage.getItem('token');
let user = JSON.parse(localStorage.getItem('user') || 'null');
let currentPage = 1;
let currentCategory = 'å…¨éƒ¨';
let categories = [];
let isLoginMode = true;
let editingUserId = null;
let selectedFiles = [];
let activeUploads = new Map();

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadResources();
    loadStats();
    loadAnnouncements();
    updateNav();
    setupUploadArea();
    document.getElementById('searchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') searchResources();
    });
    window.addEventListener('resize', () => {
        currentPage = 1;
        loadResources();
    });
});

// APIè°ƒç”¨
async function api(path, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers
    };
    if (token) {
        headers.Authorization = `Bearer ${token}`;
    }
    const response = await fetch(API + path, { ...options, headers });
    if (!response.ok) {
        const err = await response.json().catch(() => ({ error: 'Request failed' }));
        throw new Error(err.error || 'Request failed');
    }
    return response.json();
}

// å·¥å…·å‡½æ•°
function toast(message, type = 'success') {
    const div = document.createElement('div');
    div.className = `toast ${type}`;
    div.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âœ—'}</span><span>${message}</span>`;
    document.getElementById('toastContainer').appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function updateNav() {
    const navBtns = document.getElementById('navBtns');
    if (user) {
        navBtns.innerHTML = `
            <div class="user-info">
                <div class="user-avatar">${user.username[0].toUpperCase()}</div>
                <span style="font-size:.85rem">${user.username}</span>
            </div>
            ${user.role === 'admin' ? '<button class="btn btn-ghost" onclick="openAdminPanel()">âš™ ç®¡ç†</button>' : ''}
            <button class="btn btn-primary" onclick="openModal('uploadModal')">ğŸ“¤ ä¸Šä¼ </button>
            <button class="btn btn-ghost" onclick="logout()">ğŸšª ç™»å‡º</button>
        `;
    } else {
        navBtns.innerHTML = '<button class="btn btn-primary" onclick="openModal(\'loginModal\')">ğŸ” ç™»å½•</button>';
    }
}

function requireLogin() {
    if (!user) {
        openModal('loginModal');
        return false;
    }
    return true;
}

// ä¸Šä¼ ç›¸å…³å‡½æ•°
function setupUploadArea() {
    const area = document.getElementById('uploadArea');
    const input = document.getElementById('fileInput');
    area.onclick = () => input.click();
    input.onchange = e => {
        if (e.target.files.length > 0) addFiles(Array.from(e.target.files));
    };
    area.ondragover = e => {
        e.preventDefault();
        area.classList.add('dragover');
    };
    area.ondragleave = () => area.classList.remove('dragover');
    area.ondrop = e => {
        e.preventDefault();
        area.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) addFiles(Array.from(e.dataTransfer.files));
    };
}

function addFiles(files) {
    files.forEach(file => {
        if (file.size > 7 * 1024 * 1024 * 1024) {
            toast(`æ–‡ä»¶ ${file.name} è¶…è¿‡7GBé™åˆ¶`, 'error');
            return;
        }
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
        }
    });
    renderFileList();
}

function renderFileList() {
    const fileList = document.getElementById('fileList');
    if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    fileList.innerHTML = selectedFiles.map((file, i) => `
        <div class="file-item">
            <div class="file-item-info">
                <span>${file.name}</span>
                <span style="color:var(--text-muted);font-size:.7rem;margin-left:.4rem">(${formatSize(file.size)})</span>
            </div>
            <button class="file-item-remove" onclick="removeFile(${i})">âœ•</button>
        </div>
    `).join('');
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}

function closeUploadModal() {
    closeModal('uploadModal');
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('uploadDesc').value = '';
    document.getElementById('fileInput').value = '';
    selectedFiles = [];
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
    return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}

function formatSpeed(bytes) {
    if (bytes < 1024) return bytes.toFixed(0) + ' B/s';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB/s';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB/s';
}

function showGlobalProgress() {
    document.getElementById('globalProgress').classList.add('active');
}

function hideGlobalProgress() {
    document.getElementById('globalProgress').classList.remove('active');
}

function updateProgressList() {
    const progressList = document.getElementById('progressList');
    if (activeUploads.size === 0) {
        progressList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:1rem;font-size:.8rem">æ²¡æœ‰æ´»è·ƒçš„ä¸Šä¼ ä»»åŠ¡</div>';
        return;
    }
    let html = '';
    activeUploads.forEach((uploadInfo, uploadId) => {
        const progressPercent = uploadInfo.progress || 0;
        html += `
            <div class="upload-progress-item ${uploadInfo.status === 'completed' ? 'progress-completed' : ''} ${uploadInfo.status === 'error' ? 'progress-error' : ''}" id="progress-${uploadId}">
                <div class="upload-progress-header">
                    <div class="upload-progress-name" title="${uploadInfo.fileName}">${uploadInfo.fileName}</div>
                    <div class="upload-progress-size">${formatSize(uploadInfo.uploaded || 0)} / ${formatSize(uploadInfo.totalSize)}</div>
                </div>
                <div class="upload-progress-bar"><div class="upload-progress-fill" style="width: ${progressPercent}%"></div></div>
                <div class="upload-progress-stats">
                    <div class="upload-progress-percent">${progressPercent.toFixed(1)}%</div>
                    <div class="upload-progress-speed">${uploadInfo.speed ? formatSpeed(uploadInfo.speed) : '0 B/s'}</div>
                    <div class="upload-progress-time">${uploadInfo.elapsedTime ? uploadInfo.elapsedTime.toFixed(1) + 's' : '0s'}</div>
                </div>
            </div>
        `;
    });
    progressList.innerHTML = html;
}

async function startUpload() {
    if (!requireLogin()) return;
    if (selectedFiles.length === 0) {
        toast('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
        return;
    }
    
    const desc = document.getElementById('uploadDesc').value;
    const filesToUpload = [...selectedFiles];
    console.log('å‡†å¤‡ä¸Šä¼ æ–‡ä»¶:', filesToUpload.length, 'ä¸ª');
    
    closeUploadModal();
    showGlobalProgress();
    
    const uploadPromises = filesToUpload.map(file => uploadFileWithProgress(file, desc));
    try {
        await Promise.all(uploadPromises);
        hideGlobalProgress();
    } catch (error) {
        console.error('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
        hideGlobalProgress();
    }
}

async function uploadFileWithProgress(file, description = '') {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('description', description);
    
    console.log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'å­—èŠ‚');
    
    try {
        const response = await fetch(`${API}/upload`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        console.log('ä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
            let errorMsg = 'ä¸Šä¼ å¤±è´¥';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {}
            console.error('ä¸Šä¼ é”™è¯¯å“åº”:', errorMsg);
            throw new Error(errorMsg);
        }
        
        const result = await response.json();
        console.log('ä¸Šä¼ æˆåŠŸï¼Œè¿”å›:', result);
        
        if (result.upload_id) {
            activeUploads.set(result.upload_id, {
                fileName: file.name,
                totalSize: file.size,
                uploaded: 0,
                progress: 0,
                speed: 0,
                elapsedTime: 0,
                status: 'uploading'
            });
            updateProgressList();
            checkUploadProgress(result.upload_id, file.name, file.size);
        }
        return result;
    } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        toast(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        throw error;
    }
}

async function checkUploadProgress(uploadId, fileName, fileSize) {
    const interval = setInterval(async () => {
        try {
            const progress = await api(`/upload/progress/${uploadId}`);
            if (progress) {
                activeUploads.set(uploadId, {
                    fileName: fileName,
                    totalSize: fileSize,
                    uploaded: progress.uploaded || 0,
                    progress: progress.progress || 0,
                    speed: progress.speed || 0,
                    elapsedTime: progress.elapsed_time || 0,
                    status: progress.status || 'uploading'
                });
                updateProgressList();
                
                if (progress.status === 'completed') {
                    clearInterval(interval);
                    toast(`æ–‡ä»¶ ${fileName} ä¸Šä¼ æˆåŠŸ`);
                    setTimeout(() => {
                        activeUploads.delete(uploadId);
                        updateProgressList();
                        if (activeUploads.size === 0) {
                            hideGlobalProgress();
                            loadResources();
                            loadStats();
                        }
                    }, 2000);
                } else if (progress.status === 'error') {
                    clearInterval(interval);
                    toast(`æ–‡ä»¶ ${fileName} ä¸Šä¼ å¤±è´¥: ${progress.error_message}`, 'error');
                    setTimeout(() => {
                        activeUploads.delete(uploadId);
                        updateProgressList();
                        if (activeUploads.size === 0) {
                            hideGlobalProgress();
                        }
                    }, 3000);
                }
            }
        } catch (error) {
            console.error('è·å–ä¸Šä¼ è¿›åº¦å¤±è´¥:', error);
        }
    }, 300);
}

// å…¶ä»–å‡½æ•°ï¼ˆä½¿ç”¨åŸå§‹ä»£ç ä¿ç•™ï¼‰...
async function submitAuth() {}
function logout() {}
async function loadCategories() {}
function filterCategory(c) {}
async function loadResources() {}
function initLazyLoading() {}
function renderCard(r) {}
function renderPagination(pages) {}
function goPage(p) {}
function searchResources() {}
async function showDetail(id) {}
async function downloadResource(id) {}
async function deleteResource(id) {}
async function updateResource(id) {}
async function loadStats() {}
async function loadAnnouncements() {}
async function openAdminPanel() {}
async function switchAdminTab(tab) {}
async function loadAnnouncementsTable() {}
function editUser(id, username, role) {}
async function saveUser() {}
async function addUser() {}
async function deleteUser(id) {}
async function addAnnouncement() {}
async function deleteAnnouncement(id) {}
function toggleAuthMode() {}
</script>
</body>
</html>
